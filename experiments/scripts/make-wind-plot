#!/usr/bin/perl

# Arguments:
#
# 1. winfile
# 2. oinfile
# 3. Model label
# 5. Wind vector step
my $winfile = $ARGV[0];
my $oinfile = $ARGV[1];
my $model_label = $ARGV[2];
my $wstep = $ARGV[3];

print "winfile=$winfile\n";
print "oinfile=$oinfile\n";
print "model_label=$model_label\n";
print "wstep=$wstep\n";

open PH, "|ncl";
print PH <<"EOF";
load "\$NCARG_ROOT/lib/ncarg/nclscripts/csm/gsn_code.ncl"
load "\$NCARG_ROOT/lib/ncarg/nclscripts/csm/gsn_csm.ncl"

winfile = "$winfile"
oinfile = "$oinfile"
model_label = "$model_label"
wstep = $wstep

begin
  wfp = addfile(winfile, "r")
  ofp = addfile(oinfile, "r")
  omega = ofp->omega
  uup = wfp->uupper
  vup = wfp->vupper
  ulo = wfp->ulower
  vlo = wfp->vlower

  wks = gsn_open_wks("ps", "wind-plots")
  gsn_define_colormap(wks, "BlueWhiteOrangeRed")
  gsn_reverse_colormap(wks)
  NhlSetColor(wks, 253,   0/255.0, 224/255.0,   0/255.0)
  NhlSetColor(wks, 254, 224/255.0,   0/255.0, 224/255.0)
  NhlSetColor(wks, 255, 192/255.0, 192/255.0, 192/255.0)

  plots = new(4, graphic)
  panel_labels = new(4, string)

  seas_labels = (/ "DJF", "MAM", "JJA", "SON" /)

  res = True

  res\@tiMainString = ""
  res\@tiYAxisString = ""
  res\@tiXAxisString = ""
  res\@gsnLeftString = ""
  res\@gsnRightString = ""
  res\@gsnSpreadColors = True
  res\@gsnSpreadColorEnd = 252
  res\@cnLevelSelectionMode = "ManualLevels"
  res\@cnLevelSpacingF = 0.01
  res\@cnMinLevelValF = -0.1
  res\@cnMaxLevelValF = 0.1
  res\@cnLineLabelsOn = False
  res\@cnFillOn = True
  res\@cnLinesOn = False

  res\@mpLandFillColor = 255

  res\@lbLabelBarOn = False

  res\@gsnDraw = False
  res\@gsnFrame = False

  res\@tmXTOn = False
  res\@tmXBOn = False
  res\@tmYLOn = False
  res\@tmYROn = False

  vres1 = True
  vres1\@tiYAxisString = ""
  vres1\@tiXAxisString = ""
  vres1\@gsnAddCyclic = False
  vres1\@gsnLeftString = ""
  vres1\@gsnRightString = ""
  vres1\@gsnFrame = False
  vres1\@gsnDraw = False
  vres1\@vcVectorDrawOrder = "PostDraw"
  vres1\@vcGlyphStyle = "FillArrow"
  vres1\@vcFillArrowFillColor = 253
  vres1\@vcFillArrowEdgeColor = "black"
  vres1\@vcRefLengthF = 0.02
  vres1\@vcRefMagnitudeF = 10
  vres1\@vcRefAnnoString1 = "10 m/s"
  vres1\@vcRefAnnoString2 = "Lower level wind"
  vres1\@vcRefAnnoOn = False
  vres1\@vcRefAnnoPerimOn = False
  vres1\@vcRefAnnoFontHeightF = 0.015
  vres1\@vcRefAnnoOrthogonalPosF = 0.15
  vres1\@vcRefAnnoParallelPosF = 0.975

  vres2 = True
  vres2\@tiYAxisString = ""
  vres2\@tiXAxisString = ""
  vres2\@gsnAddCyclic = False
  vres2\@gsnLeftString = ""
  vres2\@gsnRightString = ""
  vres2\@gsnFrame = False
  vres2\@gsnDraw = False
  vres2\@vcVectorDrawOrder = "PostDraw"
  vres2\@vcGlyphStyle = "FillArrow"
  vres2\@vcFillArrowFillColor = 254
  vres2\@vcFillArrowEdgeColor = "black"
  vres2\@vcRefLengthF = 0.02
  vres2\@vcRefMagnitudeF = 20
  vres2\@vcRefAnnoString1 = "20 m/s"
  vres2\@vcRefAnnoString2 = "Upper level wind"
  vres2\@vcRefAnnoOn = False
  vres2\@vcRefAnnoPerimOn = False
  vres2\@vcRefAnnoFontHeightF = 0.015
  vres2\@vcRefAnnoOrthogonalPosF = 0.15
  vres2\@vcRefAnnoParallelPosF = 0.7

  pi = 0
  do row = 0, 1
    do col = 0, 1
      if (row .eq. 1 .and. col .eq. 1) then
        vres1\@vcRefAnnoOn = True
        vres2\@vcRefAnnoOn = True
      end if

      plots(pi) = gsn_csm_contour_map_ce(wks, omega(pi, :, :), res)
      v1 = gsn_csm_vector(wks, ulo(pi, ::wstep,::wstep), \\
                               vlo(pi, ::wstep,::wstep), vres1)
      v2 = gsn_csm_vector(wks, uup(pi, 1::wstep,1::wstep), \\
                               vup(pi, 1::wstep,1::wstep), vres2)
      overlay(plots(pi), v1)
      overlay(plots(pi), v2)

      panel_labels(pi) = model_label + " (" + seas_labels(pi) + ")"
      pi = pi + 1
    end do
  end do

  pw = 0.406212
  ph = 0.203106
  pgapx = 0.0211234
  pgapy = 0.0211234
  px1 = 0.0895986
  py1 = 0.980996
  panelx = new(4, float)
  panely = new(4, float)
  pidx = 0
  do r = 0, 1
    do c = 0, 1
      panelx(pidx) = px1 + (pw + pgapx) * c
      panely(pidx) = py1 - (ph + pgapy) * r
      pidx = pidx + 1
    end do
  end do

  pres = True
;  pres\@gsnPanelDebug = True
  pres\@gsnPanelXF = panelx
  pres\@gsnPanelYF = panely
  pres\@gsnFrame = False
  pres\@gsnPanelFigureStrings = panel_labels
  pres\@gsnPanelFigureStringsPerimOn = False
  pres\@gsnPanelFigureStringsPerimSpaceF = 0.125
  pres\@gsnPanelFigureStringsFontHeightF = 0.01
  pres\@amJust = "BottomLeft"
  gsn_panel(wks, plots, (/ 4, 2 /), pres)

  contour = get_overlay_plot(plots(0), "contourPlotClass", 0)
  getvalues contour
    "cnLevels": lblevels
    "cnFillColors": lbcolors
  end getvalues

  do idx = 0, dimsizes(lblevels) - 1
    if (abs(lblevels(idx)) .lt. 0.001) then
      lblevels(idx) = 0.0
    end if
  end do

  lbres = True
  lbw = 0.55
  lbh = 0.05
  lbres\@vpWidthF = lbw
  lbres\@vpHeightF = lbh
  lbres\@lbMonoFillPattern = True
  lbres\@lbLabelFontHeightF = 0.015
  lbres\@lbLabelAlignment = "InteriorEdges"
  lbres\@lbPerimOn = False
  lbres\@lbOrientation = "Horizontal"
  lbres\@lbFillColors = lbcolors
  lbres\@lbTitleString = "Vertical pressure velocity (Pa/s)"
  lbres\@lbTitleFontHeightF = 0.015
  lbres\@lbTitleOffsetF = 0.2
  lbres\@lbTitlePosition = "Bottom"
  lbres\@lbLabelStride = 2
  lblabels = new(dimsizes(lblevels), string)
  lblabels = lblevels

  lbx = (0.75 - lbw) / 2.0
  lby = 0.505
  gsn_labelbar_ndc(wks, dimsizes(lbcolors), lblabels, lbx, lby, lbres)

  frame(wks)
end
EOF

close PH;

system "ps2eps -f -l wind-plots.ps";
system "epstopdf wind-plots.eps";
unlink "wind-plots.ps";
unlink "wind-plots.eps";
